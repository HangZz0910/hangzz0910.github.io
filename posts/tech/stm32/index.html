<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>STM32基础 | 杭の小屋</title>
<meta name="keywords" content="">
<meta name="description" content="STM32介绍 基于ARM Cortex-M内核开发的32位微控制器 STM32F103C8T6 内核：ARM Cortex-M3 主频：72MHz RAM：20K(SRAM) ROM：64K(Flash) 供电：2.0~3.6V(标准3.3V) 封装：LQFP48 片上资源/外设 NVIC嵌套向量中断控制器：内核里面用于管理中断的设备，比如">
<meta name="author" content="Hang">
<link rel="canonical" href="https://hangzz0910.github.io/posts/tech/stm32/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://hangzz0910.github.io/img/H.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://hangzz0910.github.io/img/H.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://hangzz0910.github.io/img/H.jpg">
<link rel="apple-touch-icon" href="https://hangzz0910.github.io/img/H.jpg">
<link rel="mask-icon" href="https://hangzz0910.github.io/img/H.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="STM32基础" />
<meta property="og:description" content="STM32介绍 基于ARM Cortex-M内核开发的32位微控制器 STM32F103C8T6 内核：ARM Cortex-M3 主频：72MHz RAM：20K(SRAM) ROM：64K(Flash) 供电：2.0~3.6V(标准3.3V) 封装：LQFP48 片上资源/外设 NVIC嵌套向量中断控制器：内核里面用于管理中断的设备，比如" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hangzz0910.github.io/posts/tech/stm32/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-05T15:07:17+08:00" />
<meta property="article:modified_time" content="2024-08-05T15:07:17+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="STM32基础"/>
<meta name="twitter:description" content="STM32介绍 基于ARM Cortex-M内核开发的32位微控制器 STM32F103C8T6 内核：ARM Cortex-M3 主频：72MHz RAM：20K(SRAM) ROM：64K(Flash) 供电：2.0~3.6V(标准3.3V) 封装：LQFP48 片上资源/外设 NVIC嵌套向量中断控制器：内核里面用于管理中断的设备，比如"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "https://hangzz0910.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "👨🏻‍💻 技术",
          "item": "https://hangzz0910.github.io/posts/tech/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "STM32基础",
      "item": "https://hangzz0910.github.io/posts/tech/stm32/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "STM32基础",
  "name": "STM32基础",
  "description": "STM32介绍 基于ARM Cortex-M内核开发的32位微控制器 STM32F103C8T6 内核：ARM Cortex-M3 主频：72MHz RAM：20K(SRAM) ROM：64K(Flash) 供电：2.0~3.6V(标准3.3V) 封装：LQFP48 片上资源/外设 NVIC嵌套向量中断控制器：内核里面用于管理中断的设备，比如",
  "keywords": [
    ""
  ],
  "articleBody": "STM32介绍 基于ARM Cortex-M内核开发的32位微控制器\nSTM32F103C8T6 内核：ARM Cortex-M3 主频：72MHz RAM：20K(SRAM) ROM：64K(Flash) 供电：2.0~3.6V(标准3.3V) 封装：LQFP48 片上资源/外设 NVIC嵌套向量中断控制器：内核里面用于管理中断的设备，比如配置中断优先级 SysTick系统滴答定时器：内核里的定时器，给操作系统（如FreeRTOS、UCOS）提供定时服务，定时进行任务切换的功能 RCC复位和时钟控制：外设在上电的情况下默认没有时钟，不给时钟情况下，操作无效，外设也不会工作，这样的目的是降低功耗。所以在操作外设前要先操作时钟，使用RCC完成时钟的使能。 GPIO通用IO口 AFIO复用IO口：完成复用功能端口的重定义，还有中断端口的配置 EXTI外部中断：配置好外部中断后，当引脚有电平变化时，可以触发中断，让CPU来处理任务 TIM定时器：高级定时器、通用定时器、基本定时器，不仅可以完成定时中断，还可以完成测频率、生成PWM波形、配置成专用的编码器接口等 ADC模数转换器：STM32内置了12位的AD转换器，可以直接读取IO口的模拟电压值，无需外部连接AD芯片 DMA直接内存访问：帮助CPU完成大量数据搬运功能 USART同步/异步串口通信 I2C通信、SPI通信：通信协议 CAN通信：一般用于汽车领域 RTC实时时钟：在STM32内部完成年月日、时分秒的计时功能，且可以接外部备用电池，即使掉电也能正常运行 CRC校验：用于判断数据的正确性 PWR电源控制：可以让芯片进入睡眠模式等状态，来达到省电的目的 BKP备份寄存器：存储器，当系统掉电时，仍可由备用电池保持数据 IWDG独立看门狗、WWDG窗口看门狗：当单片机因为电磁干扰死机或者程序设计不合理出现死循环时，看门狗可以及时复位芯片，保持系统稳定 DAC数模转换器，可以在IO口直接输出模拟电压 FSMC可变静态存储控制器：用于扩展内存，或者配置成其他总线协议，用于某些硬件操作 USB OTG：USB主机接口，用OTG功能，可以让STM32作为USB主机去读取其他USB设备 系统结构 左上方Cortex-M3内核，引出3条总线，ICode指令总线、DCode数据总线、System系统总线，ICode与DCode主要用于连接Flash闪存，Flash里是编写的程序，ICode用来加载程序指令，DCode用来加载数据，System系统总线连接到其他上面，比如SRAM存储程序运行数据，AHB（先进高性能总线）系统总线用于挂在主要的外设，APB（先进外设总线）用于连接一般外设，由于AHB和APB的总线协议、总线速度、还有数据传送格式的差异，所以中间需要加两个桥接，来完成数据的转换和缓存。 DMA可看作内核CPU的小秘书，比如一些大量的数据搬运。DMA通过DMA总线连接到总线矩阵上，可以拥有和CPU一样的总线控制权，用于访问这些外设。当需要DMA搬运数据时，外设就会通过请求线发送DMA请求，然后DMA就会获得总线控制权，访问并转运数据， 整个过程无需CPU的参与。 引脚定义 红色是电源相关引脚，蓝色是最小系统相关引脚，绿色是IO口、功能口引脚\n启动配置 一般情况下，程序都是在Flash程序存储器开始执行，但是某些情况下可以让程序在别的地方开始执行，用来完成特殊的功能。\n最小系统电路 新建工程 建立工程文件夹，keil中新建工程、选择型号 工程文件夹中建立Start、Library、User等文件夹，复制固件库中的文件到工程文件中 工程里对应建立Start、Library、User等同名称的分组，然后将文件夹内的文件添加到工程分组里 工程选项，C/C++，Include Paths内声明所有包含头文件的文件夹 工程选项，C/C++，Define内定义USE_STDPERIPH_DRIVER 工程选项，Debug，下拉列表选择对应调试器，Settings，Flash Download里勾选Reset and Run 工程架构 C语言 宏定义 关键字：#define 用途：用一个字符串代替一个数字，便于理解防止出错；提取程序中经常出现的参数，便于快速修改 定义宏定义：#define ABC 12345 引用宏定义：int a = ABC；//等效int a = 12345； typedef 用途：将一个比较长的变量类型名换个名字，便于使用 定义：typedef unsigned char uint8_t; 引用 ：uint8_t a;//等效于unsigned char a； 结构体 关键字：struct 用途：数据打包，不同类型变量的集合 定义结构体变量 struct{char x;int y;float z;} StructName; 因为结构体变量类型较长，所以通常用typedef更改其变量类型名 引用结构体成员： StructName.x = ‘A’； pStructName-\u003ex = ‘A’；//pStructName为结构体的地址 枚举 关键字：enum 用途：定义一个取值受限制的整形变量，用于限制变量取值范围；宏定义的集合 定义枚举变量：enum{FALSE = 0 , TRUE = 1} EnumName; 引用枚举成员：EnumName = FALSE; GPIO GPIO简介 General Purpose Input Output通用输入输出口 可配置为8种输入输出模式 引脚电平0-3.3V，部分引脚可容忍5V 输出模式下可控制端口输出高低电平，用来驱动LED、控制蜂鸣器、模拟通信协议输出时序 输入模式下可读取端口的高低电平或电压，用于读取按键输入，外界模块电平信号输入、ADC电压采集、模拟通信协议接收数据 GPIO 基本结构 在STM32中，所有GPIO都挂载在APB2外设总线上，其中GPIO名称按照GPIOA、GPIOB…….来标注，每个GPIO外设总共有16个引脚从0到15。\n寄存器是特殊的存储器，内核可以通过APB2总线对寄存器进行读写，这样可以完成输出电平和读取电平的功能。寄存器的每一位对应一个引脚，其中输出寄存器写1，对应的引脚就会输出高电平，反之输出低电平；输入寄存器读取为1，就证明对应的端口目前是高电平，反之为低电平。由于STM32为32位的单片机，所以STM32内部的寄存器都是32位的，但是端口只有16位，该寄存器只有低16位对应的有端口，高16位没用到。寄存器只负责存储数据，如要进行其他操作，还需要驱动器来负责增大驱动能力。\nGPIO位结构 左侧为三个寄存器，中间为驱动器，右侧为某一个IO口的引脚。\n整体可分为两个部分，上面为输入部分，下面为输出部分。VDD、VSS的两个开关，是为了给输入提供一个默认的输入电平（上拉、下拉、浮空），因为对应一个数字的端口，输入不是高电平就是低电平，如果浮空，引脚的输入电平会受外界干扰而改变。上拉输入可称作是默认为高电平的输入模式，下拉输入是默认为低电平的输入模式。\n输入部分：\nTTL肖特基触发器，其实就是施密特触发器，对输入电压进行整形，当输入电压大于某一阈值，输出电压为高电平，当输入电压小于某一阈值，输出电压为低电平。可以有效避免因信号波动造成的输出抖动现象。\n经过施密特触发器整形的波形可以直接写入输入数据寄存器了，再用程序读取输入寄存器对应某一位的数据，就可以知道端口的输入电平。\n模拟输入连接到ADC上，因为ADC需要接受模拟量，所以要接触发器前面。\n复用功能输入是连接到其他需要读取端口的外设上的，接触发器后面。\n**输出部分：**由输出数据寄存器和片上外设控制\n两种控制方式通过数据选择器连接到了输出控制部分，如果选择通过输出数据寄存器进行控制，就是普通的IO口输出，写这个数据寄存器的某一位就可以操作对应的某个端口了。\n位设置/清除寄存器，可以单独操作输出数据寄存器的某一位，而不影响其他位。因为这个输出数据寄存器同时控制16个端口，并且这个寄存器只能整体读写，所以如果想单独控制其中某一个端口而不影响其他端口，需要特殊的操作方式（按位与、设置位设置/清除寄存器）。\n通过信号来控制MOS管开关的导通和关闭，开关负责将IO口接到ADD或者VSS，可选择推挽、开漏或关闭三种输出方式。①在推挽输出模式下，PMOS和NMOS均有效，数据寄存器位1时，上管导通下管断开，输出直接接到VDD，就是输出高电平，反之输出低电平。在此模式下，STM32对IO口具有绝对的控制权。②在开漏输出模式下，PMOS无效，只有NMOS在工作，数据寄存器为1时，输出相当于断开也就是高阻模式，数据寄存器为0时，下管导通，输出直接接到VSS，也就是低电平。这种模式下，只有低电平有驱动能力，高电平没有驱动能力。可作为通信协议的驱动方式，在多机通信的情况下，这个模式可以避免各个设备的相互干扰，另外还可用于输出5V的电平信号③在关闭模式下，是当引脚配置为输入模式时，两个MOS管都无效，端口的电平由外部信号来控制。\n8种工作模式 模式名称 性质 特征 浮空输入 数字输入 可读取引脚电平，若引脚悬空，则电平不确定 上拉输入 数字输入 可读取引脚电平，内部连接上拉电阻，悬空时默认高电平 下拉输入 数字输入 可读取引脚电平，内部连接下拉电阻，悬空时默认低电平 模拟输入 模拟输入 GPIO无效，引脚直接接入内部ADC 开漏输出 数字输出 可输出引脚电平，高电平为高阻态，低电平接VSS 推挽输出 数字输出 可输出引脚电平，高电平接VDD，低电平接VSS 复用开漏输出 数字输出 由片上外设控制，高电平为高阻态，低电平接VSS 复用推挽输出 数字输出 由片上外设控制，高电平接VDD，低电平接VSS 浮空输入、上拉输入、下拉输入的电路结构基本一致，区别就是上拉电阻和下拉电阻的连接。在输入模式下，输出驱动器断开，只能输入而不能输出\n模拟输入，是ADC模数转换器的专属配置，输出断开，输入的施密特触发器也是关闭的无效状态\n开漏/推挽输出的区别在于高电平，开漏是高阻态，推挽是VDD\n复用开漏/推挽输出的结构如下，都由片上外设控制\n常用函数以及样例 初始化样例 1 2 3 4 5 GPIO_InitTypeDef GPIO_InitStructure; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOB,\u0026GPIO_InitStructre); GPIO_Init需要输入两个参数，第一个参数是指定GPIOx（其中X可以为A…G），第二个参数是一个指向GPIO_InitTypeDef结构的指针，因此我们还需要定义一个结构体，通过GPIO_InitTypeDef的方式定义，定义后需要对三个参数进行设置：\nGPIO_Mode设置：也就是对工作模式进行选择，模拟输入AIN、浮空输入IN_FLOATING、下拉输入IPD、上拉输入IPU、开漏输出Out_OD、推挽输出Out_PP、复用开漏输出AF_OD、复用推挽输出AF_PP GPIO_Pin设置：也就是对引脚进行选择，可以从GPIO_Pin_0~GPIO_Pin_15，共16个引脚，也可以使用GPIO_Pin_All对所有引脚进行选择，也可以使用或(|)的方式进行选择，GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2，使用此方式对引脚012进行选择 GPIO_Speed设置：输出速度可选择GPIO_Speed_10MHz,GPIO_Speed_2MHz,GPIO_Speed_50MHz 按样例定义完成后，GPIOB外设的12号引脚就自动被配置为推挽输出、50MHz的速度了，它内部的主要执行逻辑就是读取结构体的参数，执行判断和运算，最后写入到GPIO配置寄存器中\n输出操作 常用的四个操作如下\n1 2 3 4 void GPIO_SetBits(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin); void GPIO_ResetBits(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin); void GPIO_WriteBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin, BitAction BitVal); void GPIO_Write(GPIO_TypeDef* GPIOx, uint16_t PortVal); SetBits完成对某GPIO外设的某引脚置1 ResetBits完成对某GPIO外设的某引脚置0 WriteBit(GPIOx,GPIO_Pin_X,Bit_SET/Bit_RESET) Write第一个参数是选定一个GPIO外设，第二个参数是一个4位16进制数，为16个二进制，对应着16个端口，最低位为PA0，如0x0001对应0000 0000 0000 0001即Pin0置1,0x0003对应0000 0000 0000 0011即Pin0\\Pin1置1 输入操作 按键介绍 按键：常见的输入设备，按下导通，松手断开\n按键抖动：由于按键内部使用的是机械式弹簧片来进行通断的，所以在按下和松手的瞬间会伴有一连串的抖动\n初始化按键可采用上拉输入IPU\n1 2 3 4 5 6 7 8 9 10 11 12 13 uint8_t Key_GetNum(void) { uint8_t KeyNum = 0; if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_1)==0) { Delay_ms(20); while (GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_1)==0); Delay_ms(20); KeyNum = 1; } if.......//按其他端口，KeyNum为其他值 return KeyNum; } 传感器介绍 传感器元件的电阻会随外界模拟量的变化而变化，通过与定值电阻分压即可得到模拟电压输入，再通过电压比较器进行二值化即可得到数字电压输出\n硬件电路 下接按键方式（通常普遍采用）\n若采用左侧方式，必须采用上拉输入，否则会出现引脚悬空，输出不确定\n上接按键方式\n连接方式：VCC接3.3V提供电源，GND接地，DO数字输出随便接一个端口，用于读取数字量，AO模拟输出。\n传感器端口可采用上拉输入IPU\n输入代码 带有Bit是只读取一个位，无Bit是读取一整个的，每一个都以0/1表示\n1 2 3 4 uint8_t GPIO_ReadInputDataBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin); uint16_t GPIO_ReadInputData(GPIO_TypeDef* GPIOx); uint8_t GPIO_ReadOutputDataBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin); uint16_t GPIO_ReadOutputData(GPIO_TypeDef* GPIOx); OLED 样例\n函数 作用 OLED_Init(); 初始化 OLED_Clear(); 清屏 OLED_ShowChar(1, 1, ‘A’); 显示一个字符 OLED_ShowString(1, 3, “HelloWorld!”); 显示字符串 OLED_ShowNum(2, 1, 12345, 5); 显示十进制数字 OLED_ShowSignedNum(2, 7, -66, 2); 显示有符号十进制数字 OLED_ShowHexNum(3, 1, 0xAA55, 4); 显示十六进制数字 OLED_ShowBinNum(4, 1, 0xAA55, 16); 显示二进制数字 中断系统 中断概念 中断：在主程序运行进程中，出现了特定的中断触发条件，使得CPU暂停当前正在运行的程序，转而去处理中断程序，处理完成后又返回原来被暂停的位置继续运行 中断优先级：当有多个中断源同时申请中断，CPU会根据中断源的轻重缓急进行裁决，优先响应更加紧急的中断源 中断嵌套：当一个中断程序正在运行时，又有新的更高优先级的中断源申请中断，CPU再次暂停当前中断程序，转而去处理新的中断程序，处理完成后依次进行返回 STM32中断 68个可屏蔽中断通道，包含EXTI、TIM、ADC、USART、SPI、I2C、RTC等多个外设 使用NVIC统一管理中断，每个中断通道都有16个可编程的优先等级，可对优先级进行分组，进一步设置抢占优先级和响应优先级 NVIC基本结构 NVIC的中断优先级由优先级寄存器的4位（0~15）决定，这4位可以进行切分，分为高n位的抢占优先级和低4-n位的响应优先级 抢占优先级高的可以中断嵌套，响应优先级高的可以优先排队，抢占优先级和响应优先级均相同的按中断号排队 分组方式 抢占优先级 响应优先级 分组0 0位，取值为0 4位，取值为0~15 分组1 1位，取值为0~1 3位，取值为0~7 分组2 2位，取值为0~3 2位，取值为0~3 分组3 3位，取值为0~7 1位，取值为0~1 分组4 4位，取值为0~15 0位，取值为0 EXTI外部中断 EXTI可以监测指定GPIO口的电平信号，当其指定的GPIO口产生电平变化时，EXTI将立即向NVIC发出中断申请，经过NVIC裁决后即可中断CPU主程序，使CPU执行EXTI对应的中断程序 支持的触发方式：上升沿/下降沿/双边沿/软件触发 支持的GPIO口：所有GPIO口，但相同的Pin不能同时触发中断 通道数：16个GPIO_Pin，外加PVD输出、RTC闹钟、USB唤醒、以太网唤醒 触发响应方式：中断响应/事件响应（中断响应是正常的流程，引脚电平变化触发中断；事件响应不会触发中断，而是触发别的外设操作，属于外设之间的联合工作） 旋转编码器 旋转编码器：用来测量位置、速度或旋转方向的装置，当其旋转轴旋转时，其输出端可以输出与旋转速度和方向对应的方波信号，读取方波信号的频率和相位信息即可得知旋转轴的速度和方向 类型：机械触点式/霍尔传感器式/光栅式 基本流程 RCC时钟启用\n1 2 3 RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);//启用GPIOB RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);//启用AFIO //EXTI与NVIC本身时钟就启用，无需启动 GPIO端口配置\n1 2 3 4 5 GPIO_InitTypeDef GPIO_InitStructure;//定义结构体 GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU; GPIO_InitStructure.GPIO_Pin = GPIO_Pin_14; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOB,\u0026GPIO_InitStructure);//初始化 AFIO引脚选择\n1 GPIO_EXTILineConfig(GPIO_PortSourceGPIOB,GPIO_PinSource14);//14脚使用GPIOB的Pin14 EXTI配置\n1 2 3 4 5 6 EXTI_InitTypeDef EXTI_InitStructure;//定义结构体 EXTI_InitStructure.EXTI_Line = EXTI_Line14;//启用14引脚 EXTI_InitStructure.EXTI_LineCmd = ENABLE;//使能 EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;//中断响应 EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;//下降沿触发 EXTI_Init(\u0026EXTI_InitStructure);//初始化 NVIC配置\n1 2 3 4 5 6 7 NVIC_InitTypeDef NVIC_InitStructure;//定义结构体 NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);//分组形式，2位抢占、2位响应 NVIC_InitStructure.NVIC_IRQChannel = EXTI15_10_IRQn;//指定要启用的通道 NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;//使能 NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;//抢占优先级 NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;//响应优先级 NVIC_Init(\u0026NVIC_InitStructure);//初始化 NVIC配置后，可配置中断响应函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 //对射式红外传感器计次 void EXTI15_10_IRQHandler(void)//名称与通道名对应 { if(EXTI_GetITStatus(EXTI_Line14) == SET) { CountSensor_Count++; Delay_ms(20); EXTI_ClearITPendingBit(EXTI_Line14); } } ------------------------------------------------------------ //旋转编码器计次 int16_t Encoder_Get(void) { int16_t Temp; Temp = Encoder_Count; Encoder_Count = 0; return Temp; } void EXTI0_IRQHandler(void) { if(EXTI_GetITStatus(EXTI_Line0) == SET) { if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_1) == 0) Encoder_Count --; EXTI_ClearITPendingBit(EXTI_Line0);\t} } void EXTI1_IRQHandler(void) { if(EXTI_GetITStatus(EXTI_Line1) == SET) { if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_0) == 0) Encoder_Count ++; EXTI_ClearITPendingBit(EXTI_Line1);\t} } TIM定时器 简介 定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断 16位计数器、预分频器、自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65s的定时 不仅具备基本的定时中断功能，而且还包含内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等多种功能 根据复杂度和应用场景分为了高级定时器、通用定时器、基本定时器三种类型 类型 编号 总线 功能 高级定时器 TIM1、TIM8 APB2 拥有通用定时器全部功能，并额外具有重复计数器、死区生成、互补输出、刹车输入等功能 通用定时器 TIM2、TIM3、TIM4、TIM5 APB1 拥有基本定时器全部功能，并额外具有内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等功能 基本定时器 TIM6、TIM7 APB1 拥有定时中断、主模式触发DAC的功能 STM32F103C8T6定时器资源：TIM1、TIM2、TIM3、TIM4 基本计时器只支持向上计数，通用定时器和高级定时器支持向上计数、向下计数、中央对齐三种模式 定时中断基本结构如下\n预分频器时序如下（PSC）\n计数器计数频率：CK_CNT = CK_PSC / (PSC + 1)\n计数器时序如下（ARR）\n计数器溢出频率：CK_CNT_OV = CK_CNT / (ARR + 1)= CK_PSC / (PSC + 1) / (ARR + 1)\n计数器无预装与有预装时序\n定时中断 RCC使能\n1 RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2,ENABLE); 内部时钟模式\n1 TIM_InternalClockConfig(TIM2);//内部时钟 时基单元\n1 2 3 4 5 6 7 TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;//定义结构体 TIM_TimeBaseInitStructure.TIM_ClockDivision = TIM_CKD_DIV1;//时钟分频 TIM_TimeBaseInitStructure.TIM_CounterMode = TIM_CounterMode_Up;//计数模式 TIM_TimeBaseInitStructure.TIM_Period = 10000-1;//周期 TIM_TimeBaseInitStructure.TIM_Prescaler = 7200-1;//预分频器 TIM_TimeBaseInitStructure.TIM_RepetitionCounter = 0;//重计数值 TIM_TimeBaseInit(TIM2,\u0026TIM_TimeBaseInitStructure); 使能中断\n1 TIM_ITConfig(TIM2,TIM_IT_Update,ENABLE);//更新时触发中断 NVIC\n1 2 3 4 5 6 7 NVIC_InitTypeDef NVIC_InitStructure; NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn; NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2; NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1; NVIC_Init(\u0026NVIC_InitStructure); 启动定时器\n1 TIM_Cmd(TIM2,ENABLE); 外部时钟 RCC使能\n1 2 RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2,ENABLE); RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE); GPIO配置\n1 2 3 4 5 GPIO_InitTypeDef GPIO_InitStructure; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU; GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_Init(GPIOA,\u0026GPIO_InitStructure); 外部时钟模式设置\n1 TIM_ETRClockMode2Config(TIM2,TIM_ExtTRGPSC_OFF,TIM_ExtTRGPolarity_NonInverted,0x0f); 时基单元配置\n1 2 3 4 5 6 7 TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure; TIM_TimeBaseInitStructure.TIM_ClockDivision = TIM_CKD_DIV1; TIM_TimeBaseInitStructure.TIM_CounterMode = TIM_CounterMode_Up; TIM_TimeBaseInitStructure.TIM_Period = 10-1; TIM_TimeBaseInitStructure.TIM_Prescaler = 1-1; TIM_TimeBaseInitStructure.TIM_RepetitionCounter = 0; TIM_TimeBaseInit(TIM2,\u0026TIM_TimeBaseInitStructure); 使能中断\n1 TIM_ITConfig(TIM2,TIM_IT_Update,ENABLE); NVIC配置\n1 2 3 4 5 6 7 NVIC_InitTypeDef NVIC_InitStructure; NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn; NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2; NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1; NVIC_Init(\u0026NVIC_InitStructure); 启动定时器\n1 TIM_Cmd(TIM2,ENABLE); 输出比较 OC(Output Compare)输出比较 输出比较可以通过比较CNT与CCR寄存器值的关系，来对输出电平进行置1、置0或翻转的操作，用于输出一定频率和占空比的PWM波形\n每个高级定时器和通用定时器都拥有4个输出比较通道\n高级定时器的前3个通道额外拥有死区生成和互补输出的功能\nPWM脉冲宽度调制 在具有惯性的系统中，可以通过对一系列脉冲的宽度进行调制，来等效地获得所需要的模拟参量，常应用于电机控速等领域\n参数：频率 = 1 / TS 占空比 = TON / TS 分辨率 = 占空比变化步距\n输出比较通道\n输出比较模式\n模式 描述 冻结 CNT=CCR时，REF保持为原状态 匹配时置有效电平 CNT=CCR时，REF置有效电平 匹配时置无效电平 CNT=CCR时，REF置无效电平 匹配时电平翻转 CNT=CCR时，REF电平翻转 强制为无效电平 CNT与CCR无效，REF强制为无效电平 强制为有效电平 CNT与CCR无效，REF强制为有效电平 PWM模式1 向上计数：CNTCCR时，REF置无效电平，CNT≤CCR时，REF置有效电平 PWM模式2 向上计数：CNTCCR时，REF置有效电平，CNT≤CCR时，REF置无效电平 PWM基本结构\n参数计算\nPWM频率：Freq = CK_PSC / (PSC + 1) / (ARR + 1) PWM占空比：Duty = CCR / (ARR + 1) PWM分辨率：Reso = 1 / (ARR + 1) LED呼吸灯 内部时钟配置\n1 TIM_InternalClockConfig(TIM2); 时基单元\n1 2 3 4 5 6 7 TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure; TIM_TimeBaseInitStructure.TIM_ClockDivision = TIM_CKD_DIV1; TIM_TimeBaseInitStructure.TIM_CounterMode = TIM_CounterMode_Up; TIM_TimeBaseInitStructure.TIM_Period = 100-1;//ARR TIM_TimeBaseInitStructure.TIM_Prescaler = 720-1;//PSC TIM_TimeBaseInitStructure.TIM_RepetitionCounter = 0; TIM_TimeBaseInit(TIM2,\u0026TIM_TimeBaseInitStructure); 输出比较单元\n1 2 3 4 5 6 7 TIM_OCInitTypeDef TIM_OCinitStructure; TIM_OCStructInit(\u0026TIM_OCinitStructure);//给结构体赋初始值 TIM_OCinitStructure.TIM_OCMode = TIM_OCMode_PWM1;//输出比较模式 TIM_OCinitStructure.TIM_OCPolarity = TIM_OCPolarity_High;//极性 TIM_OCinitStructure.TIM_OutputState = TIM_OutputState_Enable;//输出使能 TIM_OCinitStructure.TIM_Pulse = 50;//CCR的值 TIM_OC1Init(TIM2,\u0026TIM_OCinitStructure); GPIO\n1 2 3 4 5 GPIO_InitTypeDef GPIO_InitStructure; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;//复用推挽输出 GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz ; GPIO_Init(GPIOA,\u0026GPIO_InitStructure); 启动定时器\n1 TIM_Cmd(TIM2,ENABLE); 控制PMW调亮度\n1 2 3 4 void PWM_SetCompare1(uint16_t Compare) { TIM_SetCompare1(TIM2,Compare); } 舵机 舵机是一种根据输入PWM信号占空比来控制输出角度的装置\n输入PWM信号要求：周期为20ms，高电平宽度为0.5ms~2.5ms\nPMW配置：内部时钟配置——时基单元——输出比较单元——GPIO——启动定时器 舵机角度函数配置 直流电机 直流电机是一种将电能转换为机械能的装置，有两个电极，当电极正接时，电机正转，当电极反接时，电机反转\n直流电机属于大功率器件，GPIO口无法直接驱动，需要配合电机驱动电路来操作\nTB6612是一款双路H桥型的直流电机驱动芯片，可以驱动两个直流电机并且控制其转速和方向\nPMW配置：内部时钟配置——时基单元——输出比较单元——GPIO——启动定时器 电机配置：复用推挽输出配置GPIO——速度配置函数 输入捕获 IC（Input Capture）输入捕获 输入捕获模式下，当通道输入引脚出现指定电平跳变时，当前CNT的值将被锁存到CCR中，可用于测量PWM波形的频率、占空比、脉冲间隔、电平持续时间等参数 每个高级定时器和通用定时器都拥有4个输入捕获通道 可配置为PWMI模式，同时测量频率和占空比 可配合主从触发模式，实现硬件全自动测量 测频率 测频法：在闸门时间T内，对上升沿计次，得到N，则频率f_x=N / T 测周法：两个上升沿内，以标准频率fc计次，得到N ，则频率f_x=f_c / N 中界频率：测频法与测周法误差相等的频率点f_m=√f_c / T 测频法要求信号频率高一些，测周法要求信号频率低一些。都存在±1误差\n测占空比 ",
  "wordCount" : "9477",
  "inLanguage": "zh",
  "datePublished": "2024-08-05T15:07:17+08:00",
  "dateModified": "2024-08-05T15:07:17+08:00",
  "author":[{
    "@type": "Person",
    "name": "Hang"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://hangzz0910.github.io/posts/tech/stm32/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "杭の小屋",
    "logo": {
      "@type": "ImageObject",
      "url": "https://hangzz0910.github.io/img/H.jpg"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://hangzz0910.github.io/" accesskey="h" title="Hang&#39;s Blog (Alt + H)">
            <img src="https://hangzz0910.github.io/img/H.jpg" alt="logo" aria-label="logo"
                 height="40">Hang&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://hangzz0910.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://hangzz0910.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://hangzz0910.github.io/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="https://hangzz0910.github.io/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://hangzz0910.github.io/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://hangzz0910.github.io/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://hangzz0910.github.io/links" title="🤝 友链">
                <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://hangzz0910.github.io/">🏠 主页</a>&nbsp;»&nbsp;<a href="https://hangzz0910.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://hangzz0910.github.io/posts/tech/">👨🏻‍💻 技术</a></div>
            <h1 class="post-title">
                STM32基础
            </h1>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2024-08-05
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>9477字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>19分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Hang
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://hangzz0910.github.io/tags/stm32/" style="color: var(--secondary)!important;">STM32</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.6.22/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://hangzz0910.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId: "https://twikoo-api-rho-virid.vercel.app/", 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#stm32%e4%bb%8b%e7%bb%8d" aria-label="STM32介绍">STM32介绍</a><ul>
                        
                <li>
                    <a href="#stm32f103c8t6" aria-label="STM32F103C8T6">STM32F103C8T6</a></li>
                <li>
                    <a href="#%e7%89%87%e4%b8%8a%e8%b5%84%e6%ba%90%e5%a4%96%e8%ae%be" aria-label="片上资源/外设">片上资源/外设</a></li>
                <li>
                    <a href="#%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84" aria-label="系统结构">系统结构</a></li>
                <li>
                    <a href="#%e5%bc%95%e8%84%9a%e5%ae%9a%e4%b9%89" aria-label="引脚定义">引脚定义</a></li>
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e9%85%8d%e7%bd%ae" aria-label="启动配置">启动配置</a></li>
                <li>
                    <a href="#%e6%9c%80%e5%b0%8f%e7%b3%bb%e7%bb%9f%e7%94%b5%e8%b7%af" aria-label="最小系统电路">最小系统电路</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%96%b0%e5%bb%ba%e5%b7%a5%e7%a8%8b" aria-label="新建工程">新建工程</a><ul>
                        
                <li>
                    <a href="#%e5%b7%a5%e7%a8%8b%e6%9e%b6%e6%9e%84" aria-label="工程架构">工程架构</a></li>
                <li>
                    <a href="#c%e8%af%ad%e8%a8%80" aria-label="C语言">C语言</a><ul>
                        
                <li>
                    <a href="#%e5%ae%8f%e5%ae%9a%e4%b9%89" aria-label="宏定义">宏定义</a></li>
                <li>
                    <a href="#typedef" aria-label="typedef">typedef</a></li>
                <li>
                    <a href="#%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="结构体">结构体</a></li>
                <li>
                    <a href="#%e6%9e%9a%e4%b8%be" aria-label="枚举">枚举</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#gpio" aria-label="GPIO">GPIO</a><ul>
                        
                <li>
                    <a href="#gpio%e7%ae%80%e4%bb%8b" aria-label="GPIO简介">GPIO简介</a></li>
                <li>
                    <a href="#gpio-%e5%9f%ba%e6%9c%ac%e7%bb%93%e6%9e%84" aria-label="GPIO 基本结构">GPIO 基本结构</a></li>
                <li>
                    <a href="#gpio%e4%bd%8d%e7%bb%93%e6%9e%84" aria-label="GPIO位结构">GPIO位结构</a></li>
                <li>
                    <a href="#8%e7%a7%8d%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f" aria-label="8种工作模式">8种工作模式</a></li>
                <li>
                    <a href="#%e5%b8%b8%e7%94%a8%e5%87%bd%e6%95%b0%e4%bb%a5%e5%8f%8a%e6%a0%b7%e4%be%8b" aria-label="常用函数以及样例">常用函数以及样例</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e6%a0%b7%e4%be%8b" aria-label="初始化样例">初始化样例</a></li>
                <li>
                    <a href="#%e8%be%93%e5%87%ba%e6%93%8d%e4%bd%9c" aria-label="输出操作">输出操作</a></li>
                <li>
                    <a href="#%e8%be%93%e5%85%a5%e6%93%8d%e4%bd%9c" aria-label="输入操作">输入操作</a><ul>
                        
                <li>
                    <a href="#%e6%8c%89%e9%94%ae%e4%bb%8b%e7%bb%8d" aria-label="按键介绍">按键介绍</a></li>
                <li>
                    <a href="#%e4%bc%a0%e6%84%9f%e5%99%a8%e4%bb%8b%e7%bb%8d" aria-label="传感器介绍">传感器介绍</a></li>
                <li>
                    <a href="#%e7%a1%ac%e4%bb%b6%e7%94%b5%e8%b7%af" aria-label="硬件电路">硬件电路</a></li>
                <li>
                    <a href="#%e8%be%93%e5%85%a5%e4%bb%a3%e7%a0%81" aria-label="输入代码">输入代码</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#oled" aria-label="OLED">OLED</a></li>
                <li>
                    <a href="#%e4%b8%ad%e6%96%ad%e7%b3%bb%e7%bb%9f" aria-label="中断系统">中断系统</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ad%e6%96%ad%e6%a6%82%e5%bf%b5" aria-label="中断概念">中断概念</a></li>
                <li>
                    <a href="#stm32%e4%b8%ad%e6%96%ad" aria-label="STM32中断">STM32中断</a></li>
                <li>
                    <a href="#nvic%e5%9f%ba%e6%9c%ac%e7%bb%93%e6%9e%84" aria-label="NVIC基本结构">NVIC基本结构</a></li>
                <li>
                    <a href="#exti%e5%a4%96%e9%83%a8%e4%b8%ad%e6%96%ad" aria-label="EXTI外部中断">EXTI外部中断</a></li>
                <li>
                    <a href="#%e6%97%8b%e8%bd%ac%e7%bc%96%e7%a0%81%e5%99%a8" aria-label="旋转编码器">旋转编码器</a></li>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b" aria-label="基本流程">基本流程</a></li></ul>
                </li>
                <li>
                    <a href="#tim%e5%ae%9a%e6%97%b6%e5%99%a8" aria-label="TIM定时器">TIM定时器</a><ul>
                        
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e5%ae%9a%e6%97%b6%e4%b8%ad%e6%96%ad" aria-label="定时中断">定时中断</a></li>
                <li>
                    <a href="#%e5%a4%96%e9%83%a8%e6%97%b6%e9%92%9f" aria-label="外部时钟">外部时钟</a></li>
                <li>
                    <a href="#%e8%be%93%e5%87%ba%e6%af%94%e8%be%83" aria-label="输出比较">输出比较</a><ul>
                        
                <li>
                    <a href="#led%e5%91%bc%e5%90%b8%e7%81%af" aria-label="LED呼吸灯">LED呼吸灯</a></li>
                <li>
                    <a href="#%e8%88%b5%e6%9c%ba" aria-label="舵机">舵机</a></li>
                <li>
                    <a href="#%e7%9b%b4%e6%b5%81%e7%94%b5%e6%9c%ba" aria-label="直流电机">直流电机</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%be%93%e5%85%a5%e6%8d%95%e8%8e%b7" aria-label="输入捕获">输入捕获</a><ul>
                        
                <li>
                    <a href="#%e6%b5%8b%e9%a2%91%e7%8e%87" aria-label="测频率">测频率</a></li>
                <li>
                    <a href="#%e6%b5%8b%e5%8d%a0%e7%a9%ba%e6%af%94" aria-label="测占空比">测占空比</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="stm32介绍">STM32介绍<a hidden class="anchor" aria-hidden="true" href="#stm32介绍">#</a></h1>
<p>基于<code>ARM Cortex-M</code>内核开发的<code>32</code>位微控制器</p>
<h2 id="stm32f103c8t6">STM32F103C8T6<a hidden class="anchor" aria-hidden="true" href="#stm32f103c8t6">#</a></h2>
<ul>
<li>内核：ARM Cortex-M3</li>
<li>主频：72MHz</li>
<li>RAM：20K(SRAM)</li>
<li>ROM：64K(Flash)</li>
<li>供电：2.0~3.6V(标准3.3V)</li>
<li>封装：LQFP48</li>
</ul>
<h2 id="片上资源外设">片上资源/外设<a hidden class="anchor" aria-hidden="true" href="#片上资源外设">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240722112627204.png" alt="image-20240722112627204"  />
</p>
<ul>
<li>NVIC嵌套向量中断控制器：内核里面用于管理中断的设备，比如配置中断优先级</li>
<li>SysTick系统滴答定时器：内核里的定时器，给操作系统（如FreeRTOS、UCOS）提供定时服务，定时进行任务切换的功能</li>
<li>RCC复位和时钟控制：外设在上电的情况下默认没有时钟，不给时钟情况下，操作无效，外设也不会工作，这样的目的是降低功耗。所以在操作外设前要先操作时钟，使用RCC完成时钟的使能。</li>
<li>GPIO通用IO口</li>
<li>AFIO复用IO口：完成复用功能端口的重定义，还有中断端口的配置</li>
<li>EXTI外部中断：配置好外部中断后，当引脚有电平变化时，可以触发中断，让CPU来处理任务</li>
<li>TIM定时器：高级定时器、通用定时器、基本定时器，不仅可以完成定时中断，还可以完成测频率、生成PWM波形、配置成专用的编码器接口等</li>
<li>ADC模数转换器：STM32内置了12位的AD转换器，可以直接读取IO口的模拟电压值，无需外部连接AD芯片</li>
<li>DMA直接内存访问：帮助CPU完成大量数据搬运功能</li>
<li>USART同步/异步串口通信</li>
<li>I2C通信、SPI通信：通信协议</li>
<li>CAN通信：一般用于汽车领域</li>
<li>RTC实时时钟：在STM32内部完成年月日、时分秒的计时功能，且可以接外部备用电池，即使掉电也能正常运行</li>
<li>CRC校验：用于判断数据的正确性</li>
<li>PWR电源控制：可以让芯片进入睡眠模式等状态，来达到省电的目的</li>
<li>BKP备份寄存器：存储器，当系统掉电时，仍可由备用电池保持数据</li>
<li>IWDG独立看门狗、WWDG窗口看门狗：当单片机因为电磁干扰死机或者程序设计不合理出现死循环时，看门狗可以及时复位芯片，保持系统稳定</li>
<li>DAC数模转换器，可以在IO口直接输出模拟电压</li>
<li>FSMC可变静态存储控制器：用于扩展内存，或者配置成其他总线协议，用于某些硬件操作</li>
<li>USB OTG：USB主机接口，用OTG功能，可以让STM32作为USB主机去读取其他USB设备</li>
</ul>
<h2 id="系统结构">系统结构<a hidden class="anchor" aria-hidden="true" href="#系统结构">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240722131306966.png" alt="image-20240722131306966"  />
</p>
<ul>
<li>左上方Cortex-M3内核，引出3条总线，ICode指令总线、DCode数据总线、System系统总线，ICode与DCode主要用于连接Flash闪存，Flash里是编写的程序，ICode用来加载程序指令，DCode用来加载数据，System系统总线连接到其他上面，比如SRAM存储程序运行数据，AHB（先进高性能总线）系统总线用于挂在主要的外设，APB（先进外设总线）用于连接一般外设，由于AHB和APB的总线协议、总线速度、还有数据传送格式的差异，所以中间需要加两个桥接，来完成数据的转换和缓存。</li>
<li>DMA可看作内核CPU的小秘书，比如一些大量的数据搬运。DMA通过DMA总线连接到总线矩阵上，可以拥有和CPU一样的总线控制权，用于访问这些外设。当需要DMA搬运数据时，外设就会通过请求线发送DMA请求，然后DMA就会获得总线控制权，访问并转运数据， 整个过程无需CPU的参与。</li>
</ul>
<h2 id="引脚定义">引脚定义<a hidden class="anchor" aria-hidden="true" href="#引脚定义">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240722132842690.png" alt="image-20240722132842690"  />
</p>
<p>红色是电源相关引脚，蓝色是最小系统相关引脚，绿色是IO口、功能口引脚</p>
<h2 id="启动配置">启动配置<a hidden class="anchor" aria-hidden="true" href="#启动配置">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240722134221493.png" alt="image-20240722134221493"  />
</p>
<p>一般情况下，程序都是在Flash程序存储器开始执行，但是某些情况下可以让程序在别的地方开始执行，用来完成特殊的功能。</p>
<h2 id="最小系统电路">最小系统电路<a hidden class="anchor" aria-hidden="true" href="#最小系统电路">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240722134832174.png" alt="image-20240722134832174"  />
</p>
<h1 id="新建工程">新建工程<a hidden class="anchor" aria-hidden="true" href="#新建工程">#</a></h1>
<ul>
<li>建立工程文件夹，keil中新建工程、选择型号</li>
<li>工程文件夹中建立Start、Library、User等文件夹，复制固件库中的文件到工程文件中</li>
<li>工程里对应建立Start、Library、User等同名称的分组，然后将文件夹内的文件添加到工程分组里</li>
<li>工程选项，C/C++，Include Paths内声明所有包含头文件的文件夹</li>
<li>工程选项，C/C++，Define内定义USE_STDPERIPH_DRIVER</li>
<li>工程选项，Debug，下拉列表选择对应调试器，Settings，Flash Download里勾选Reset and Run</li>
</ul>
<h2 id="工程架构">工程架构<a hidden class="anchor" aria-hidden="true" href="#工程架构">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240723125124871.png" alt="image-20240723125124871"  />
</p>
<h2 id="c语言">C语言<a hidden class="anchor" aria-hidden="true" href="#c语言">#</a></h2>
<h3 id="宏定义">宏定义<a hidden class="anchor" aria-hidden="true" href="#宏定义">#</a></h3>
<ul>
<li>关键字：#define</li>
<li>用途：用一个字符串代替一个数字，便于理解防止出错；提取程序中经常出现的参数，便于快速修改</li>
<li>定义宏定义：#define ABC 12345</li>
<li>引用宏定义：int a = ABC；//等效int a = 12345；</li>
</ul>
<h3 id="typedef">typedef<a hidden class="anchor" aria-hidden="true" href="#typedef">#</a></h3>
<ul>
<li>用途：将一个比较长的变量类型名换个名字，便于使用</li>
<li>定义：typedef unsigned char uint8_t;</li>
<li>引用 ：uint8_t a;//等效于unsigned char a；</li>
</ul>
<h3 id="结构体">结构体<a hidden class="anchor" aria-hidden="true" href="#结构体">#</a></h3>
<ul>
<li>关键字：struct</li>
<li>用途：数据打包，不同类型变量的集合</li>
<li>定义结构体变量 struct{char x;int y;float z;} StructName;
因为结构体变量类型较长，所以通常用typedef更改其变量类型名</li>
<li>引用结构体成员：
StructName.x = &lsquo;A&rsquo;；
pStructName-&gt;x = &lsquo;A&rsquo;；//pStructName为结构体的地址</li>
</ul>
<h3 id="枚举">枚举<a hidden class="anchor" aria-hidden="true" href="#枚举">#</a></h3>
<ul>
<li>关键字：enum</li>
<li>用途：定义一个取值受限制的整形变量，用于限制变量取值范围；宏定义的集合</li>
<li>定义枚举变量：enum{FALSE = 0 , TRUE = 1} EnumName;</li>
<li>引用枚举成员：EnumName = FALSE;</li>
</ul>
<h1 id="gpio">GPIO<a hidden class="anchor" aria-hidden="true" href="#gpio">#</a></h1>
<h2 id="gpio简介">GPIO简介<a hidden class="anchor" aria-hidden="true" href="#gpio简介">#</a></h2>
<ul>
<li>General Purpose Input Output通用输入输出口</li>
<li>可配置为8种输入输出模式</li>
<li>引脚电平0-3.3V，部分引脚可容忍5V</li>
<li>输出模式下可控制端口输出高低电平，用来驱动LED、控制蜂鸣器、模拟通信协议输出时序</li>
<li>输入模式下可读取端口的高低电平或电压，用于读取按键输入，外界模块电平信号输入、ADC电压采集、模拟通信协议接收数据</li>
</ul>
<h2 id="gpio-基本结构">GPIO 基本结构<a hidden class="anchor" aria-hidden="true" href="#gpio-基本结构">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240723130327821.png" alt="image-20240723130327821"  />
</p>
<p>在STM32中，所有GPIO都挂载在APB2外设总线上，其中GPIO名称按照GPIOA、GPIOB&hellip;&hellip;.来标注，每个GPIO外设总共有16个引脚从0到15。</p>
<p>寄存器是特殊的存储器，内核可以通过APB2总线对寄存器进行读写，这样可以完成输出电平和读取电平的功能。寄存器的每一位对应一个引脚，其中输出寄存器写1，对应的引脚就会输出高电平，反之输出低电平；输入寄存器读取为1，就证明对应的端口目前是高电平，反之为低电平。由于STM32为32位的单片机，所以STM32内部的寄存器都是32位的，但是端口只有16位，该寄存器只有低16位对应的有端口，高16位没用到。寄存器只负责存储数据，如要进行其他操作，还需要驱动器来负责增大驱动能力。</p>
<h2 id="gpio位结构">GPIO位结构<a hidden class="anchor" aria-hidden="true" href="#gpio位结构">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240723131158763.png" alt="image-20240723131158763"  />
</p>
<p>左侧为三个寄存器，中间为驱动器，右侧为某一个IO口的引脚。</p>
<p>整体可分为两个部分，上面为输入部分，下面为输出部分。VDD、VSS的两个开关，是为了给输入提供一个默认的输入电平（上拉、下拉、浮空），因为对应一个数字的端口，输入不是高电平就是低电平，如果浮空，引脚的输入电平会受外界干扰而改变。上拉输入可称作是默认为高电平的输入模式，下拉输入是默认为低电平的输入模式。</p>
<p><strong>输入部分：</strong></p>
<p>TTL肖特基触发器，其实就是施密特触发器，对输入电压进行整形，当输入电压大于某一阈值，输出电压为高电平，当输入电压小于某一阈值，输出电压为低电平。可以有效避免因信号波动造成的输出抖动现象。</p>
<p>经过施密特触发器整形的波形可以直接写入输入数据寄存器了，再用程序读取输入寄存器对应某一位的数据，就可以知道端口的输入电平。</p>
<p>模拟输入连接到ADC上，因为ADC需要接受模拟量，所以要接触发器前面。</p>
<p>复用功能输入是连接到其他需要读取端口的外设上的，接触发器后面。</p>
<p>**输出部分：**由输出数据寄存器和片上外设控制</p>
<p>两种控制方式通过数据选择器连接到了输出控制部分，如果选择通过输出数据寄存器进行控制，就是普通的IO口输出，写这个数据寄存器的某一位就可以操作对应的某个端口了。</p>
<p>位设置/清除寄存器，可以单独操作输出数据寄存器的某一位，而不影响其他位。因为这个输出数据寄存器同时控制16个端口，并且这个寄存器只能整体读写，所以如果想单独控制其中某一个端口而不影响其他端口，需要特殊的操作方式（按位与、设置位设置/清除寄存器）。</p>
<p>通过信号来控制MOS管开关的导通和关闭，开关负责将IO口接到ADD或者VSS，可选择推挽、开漏或关闭三种输出方式。①在推挽输出模式下，PMOS和NMOS均有效，数据寄存器位1时，上管导通下管断开，输出直接接到VDD，就是输出高电平，反之输出低电平。在此模式下，STM32对IO口具有绝对的控制权。②在开漏输出模式下，PMOS无效，只有NMOS在工作，数据寄存器为1时，输出相当于断开也就是高阻模式，数据寄存器为0时，下管导通，输出直接接到VSS，也就是低电平。这种模式下，只有低电平有驱动能力，高电平没有驱动能力。可作为通信协议的驱动方式，在多机通信的情况下，这个模式可以避免各个设备的相互干扰，另外还可用于输出5V的电平信号③在关闭模式下，是当引脚配置为输入模式时，两个MOS管都无效，端口的电平由外部信号来控制。</p>
<h2 id="8种工作模式">8种工作模式<a hidden class="anchor" aria-hidden="true" href="#8种工作模式">#</a></h2>
<table>
<thead>
<tr>
<th><strong>模式名称</strong></th>
<th><strong>性质</strong></th>
<th><strong>特征</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>浮空输入</td>
<td>数字输入</td>
<td>可读取引脚电平，若引脚悬空，则电平不确定</td>
</tr>
<tr>
<td>上拉输入</td>
<td>数字输入</td>
<td>可读取引脚电平，内部连接上拉电阻，悬空时默认高电平</td>
</tr>
<tr>
<td>下拉输入</td>
<td>数字输入</td>
<td>可读取引脚电平，内部连接下拉电阻，悬空时默认低电平</td>
</tr>
<tr>
<td>模拟输入</td>
<td>模拟输入</td>
<td>GPIO无效，引脚直接接入内部ADC</td>
</tr>
<tr>
<td>开漏输出</td>
<td>数字输出</td>
<td>可输出引脚电平，高电平为高阻态，低电平接VSS</td>
</tr>
<tr>
<td>推挽输出</td>
<td>数字输出</td>
<td>可输出引脚电平，高电平接VDD，低电平接VSS</td>
</tr>
<tr>
<td>复用开漏输出</td>
<td>数字输出</td>
<td>由片上外设控制，高电平为高阻态，低电平接VSS</td>
</tr>
<tr>
<td>复用推挽输出</td>
<td>数字输出</td>
<td>由片上外设控制，高电平接VDD，低电平接VSS</td>
</tr>
</tbody>
</table>
<p>浮空输入、上拉输入、下拉输入的电路结构基本一致，区别就是上拉电阻和下拉电阻的连接。在输入模式下，输出驱动器断开，只能输入而不能输出</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240723135056437.png" alt="image-20240723135056437"  />
</p>
<p>模拟输入，是ADC模数转换器的专属配置，输出断开，输入的施密特触发器也是关闭的无效状态</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240723135253735.png" alt="image-20240723135253735"  />
</p>
<p>开漏/推挽输出的区别在于高电平，开漏是高阻态，推挽是VDD</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240723135716581.png" alt="image-20240723135716581"  />
</p>
<p>复用开漏/推挽输出的结构如下，都由片上外设控制</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240723135840190.png" alt="image-20240723135840190"  />
</p>
<h2 id="常用函数以及样例">常用函数以及样例<a hidden class="anchor" aria-hidden="true" href="#常用函数以及样例">#</a></h2>
<h3 id="初始化样例">初始化样例<a hidden class="anchor" aria-hidden="true" href="#初始化样例">#</a></h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GPIO_InitTypeDef GPIO_InitStructure;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Mode <span style="color:#f92672">=</span> GPIO_Mode_Out_PP;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Pin <span style="color:#f92672">=</span> GPIO_Pin_12;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Speed <span style="color:#f92672">=</span> GPIO_Speed_50MHz;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">GPIO_Init</span>(GPIOB,<span style="color:#f92672">&amp;</span>GPIO_InitStructre);
</span></span></code></pre></td></tr></table>
</div>
</div><p>GPIO_Init需要输入两个参数，第一个参数是指定GPIOx（其中X可以为A&hellip;G），第二个参数是一个指向GPIO_InitTypeDef结构的指针，因此我们还需要定义一个结构体，通过<code>GPIO_InitTypeDef</code>的方式定义，定义后需要对三个参数进行设置：</p>
<ul>
<li>GPIO_Mode设置：也就是对工作模式进行选择，模拟输入AIN、浮空输入IN_FLOATING、下拉输入IPD、上拉输入IPU、开漏输出Out_OD、推挽输出Out_PP、复用开漏输出AF_OD、复用推挽输出AF_PP</li>
<li>GPIO_Pin设置：也就是对引脚进行选择，可以从GPIO_Pin_0~GPIO_Pin_15，共16个引脚，也可以使用GPIO_Pin_All对所有引脚进行选择，也可以使用或(|)的方式进行选择，GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2，使用此方式对引脚012进行选择</li>
<li>GPIO_Speed设置：输出速度可选择GPIO_Speed_10MHz,GPIO_Speed_2MHz,GPIO_Speed_50MHz</li>
</ul>
<p>按样例定义完成后，GPIOB外设的12号引脚就自动被配置为推挽输出、50MHz的速度了，它内部的主要执行逻辑就是读取结构体的参数，执行判断和运算，最后写入到GPIO配置寄存器中</p>
<h3 id="输出操作">输出操作<a hidden class="anchor" aria-hidden="true" href="#输出操作">#</a></h3>
<p>常用的四个操作如下</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">GPIO_SetBits</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx, <span style="color:#66d9ef">uint16_t</span> GPIO_Pin);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">GPIO_ResetBits</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx, <span style="color:#66d9ef">uint16_t</span> GPIO_Pin);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">GPIO_WriteBit</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx, <span style="color:#66d9ef">uint16_t</span> GPIO_Pin, BitAction BitVal);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">GPIO_Write</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx, <span style="color:#66d9ef">uint16_t</span> PortVal);
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>SetBits完成对某GPIO外设的某引脚置1</li>
<li>ResetBits完成对某GPIO外设的某引脚置0</li>
<li>WriteBit(GPIOx,GPIO_Pin_X,Bit_SET/Bit_RESET)</li>
<li>Write第一个参数是选定一个GPIO外设，第二个参数是一个4位16进制数，为16个二进制，对应着16个端口，最低位为PA0，如0x0001对应<code>0000 0000 0000 0001</code>即Pin0置1,0x0003对应<code>0000 0000 0000 0011</code>即Pin0\Pin1置1</li>
</ul>
<h3 id="输入操作">输入操作<a hidden class="anchor" aria-hidden="true" href="#输入操作">#</a></h3>
<h4 id="按键介绍">按键介绍<a hidden class="anchor" aria-hidden="true" href="#按键介绍">#</a></h4>
<p>按键：常见的输入设备，按下导通，松手断开</p>
<p>按键抖动：由于按键内部使用的是机械式弹簧片来进行通断的，所以在按下和松手的瞬间会伴有一连串的抖动</p>
<p><strong>初始化按键可采用上拉输入IPU</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">uint8_t</span> <span style="color:#a6e22e">Key_GetNum</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> KeyNum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">GPIO_ReadInputDataBit</span>(GPIOB,GPIO_Pin_1)<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Delay_ms</span>(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">GPIO_ReadInputDataBit</span>(GPIOB,GPIO_Pin_1)<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Delay_ms</span>(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>        KeyNum <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>.......<span style="color:#75715e">//按其他端口，KeyNum为其他值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> KeyNum;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="传感器介绍">传感器介绍<a hidden class="anchor" aria-hidden="true" href="#传感器介绍">#</a></h4>
<p>传感器元件的电阻会随外界模拟量的变化而变化，通过与定值电阻分压即可得到模拟电压输入，再通过电压比较器进行二值化即可得到数字电压输出</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240724090618696.png" alt="image-20240724090618696"  />
</p>
<h4 id="硬件电路">硬件电路<a hidden class="anchor" aria-hidden="true" href="#硬件电路">#</a></h4>
<p>下接按键方式（通常普遍采用）</p>
<p>若采用左侧方式，必须采用上拉输入，否则会出现引脚悬空，输出不确定</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240724091049107.png" alt="image-20240724091049107"  />
</p>
<p>上接按键方式</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240724091117460.png" alt="image-20240724091117460"  />
</p>
<p>连接方式：VCC接3.3V提供电源，GND接地，DO数字输出随便接一个端口，用于读取数字量，AO模拟输出。</p>
<p><strong>传感器端口可采用上拉输入IPU</strong></p>
<p><img loading="lazy" src="/../pictures/assets/image-20240724091554461.png" alt="image-20240724091554461"  />
</p>
<h4 id="输入代码">输入代码<a hidden class="anchor" aria-hidden="true" href="#输入代码">#</a></h4>
<p>带有Bit是只读取一个位，无Bit是读取一整个的，每一个都以0/1表示</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">uint8_t</span> <span style="color:#a6e22e">GPIO_ReadInputDataBit</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx, <span style="color:#66d9ef">uint16_t</span> GPIO_Pin);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint16_t</span> <span style="color:#a6e22e">GPIO_ReadInputData</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint8_t</span> <span style="color:#a6e22e">GPIO_ReadOutputDataBit</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx, <span style="color:#66d9ef">uint16_t</span> GPIO_Pin);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint16_t</span> <span style="color:#a6e22e">GPIO_ReadOutputData</span>(GPIO_TypeDef<span style="color:#f92672">*</span> GPIOx);
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="oled">OLED<a hidden class="anchor" aria-hidden="true" href="#oled">#</a></h1>
<p>样例</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240725101848324.png" alt="image-20240725101848324"  />
</p>
<table>
<thead>
<tr>
<th><strong>函数</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>OLED_Init();</td>
<td>初始化</td>
</tr>
<tr>
<td>OLED_Clear();</td>
<td>清屏</td>
</tr>
<tr>
<td>OLED_ShowChar(1, 1, &lsquo;A&rsquo;);</td>
<td>显示一个字符</td>
</tr>
<tr>
<td>OLED_ShowString(1, 3, &ldquo;HelloWorld!&rdquo;);</td>
<td>显示字符串</td>
</tr>
<tr>
<td>OLED_ShowNum(2, 1, 12345, 5);</td>
<td>显示十进制数字</td>
</tr>
<tr>
<td>OLED_ShowSignedNum(2, 7, -66, 2);</td>
<td>显示有符号十进制数字</td>
</tr>
<tr>
<td>OLED_ShowHexNum(3, 1, 0xAA55, 4);</td>
<td>显示十六进制数字</td>
</tr>
<tr>
<td>OLED_ShowBinNum(4, 1, 0xAA55, 16);</td>
<td>显示二进制数字</td>
</tr>
</tbody>
</table>
<h1 id="中断系统">中断系统<a hidden class="anchor" aria-hidden="true" href="#中断系统">#</a></h1>
<h2 id="中断概念">中断概念<a hidden class="anchor" aria-hidden="true" href="#中断概念">#</a></h2>
<ul>
<li>中断：在主程序运行进程中，出现了特定的中断触发条件，使得CPU暂停当前正在运行的程序，转而去处理中断程序，处理完成后又返回原来被暂停的位置继续运行</li>
<li>中断优先级：当有多个中断源同时申请中断，CPU会根据中断源的轻重缓急进行裁决，优先响应更加紧急的中断源</li>
<li>中断嵌套：当一个中断程序正在运行时，又有新的更高优先级的中断源申请中断，CPU再次暂停当前中断程序，转而去处理新的中断程序，处理完成后依次进行返回</li>
</ul>
<h2 id="stm32中断">STM32中断<a hidden class="anchor" aria-hidden="true" href="#stm32中断">#</a></h2>
<ul>
<li>68个可屏蔽中断通道，包含EXTI、TIM、ADC、USART、SPI、I2C、RTC等多个外设</li>
<li>使用NVIC统一管理中断，每个中断通道都有16个可编程的优先等级，可对优先级进行分组，进一步设置抢占优先级和响应优先级</li>
</ul>
<h2 id="nvic基本结构">NVIC基本结构<a hidden class="anchor" aria-hidden="true" href="#nvic基本结构">#</a></h2>
<p><img loading="lazy" src="/../pictures/assets/image-20240725125614446.png" alt="image-20240725125614446"  />
</p>
<ul>
<li>NVIC的中断优先级由优先级寄存器的4位（0~15）决定，这4位可以进行切分，分为高n位的抢占优先级和低4-n位的响应优先级</li>
<li>抢占优先级高的可以中断嵌套，响应优先级高的可以优先排队，抢占优先级和响应优先级均相同的按中断号排队</li>
</ul>
<table>
<thead>
<tr>
<th><strong>分组方式</strong></th>
<th><strong>抢占优先级</strong></th>
<th><strong>响应优先级</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>分组0</td>
<td>0位，取值为0</td>
<td>4位，取值为0~15</td>
</tr>
<tr>
<td>分组1</td>
<td>1位，取值为0~1</td>
<td>3位，取值为0~7</td>
</tr>
<tr>
<td>分组2</td>
<td>2位，取值为0~3</td>
<td>2位，取值为0~3</td>
</tr>
<tr>
<td>分组3</td>
<td>3位，取值为0~7</td>
<td>1位，取值为0~1</td>
</tr>
<tr>
<td>分组4</td>
<td>4位，取值为0~15</td>
<td>0位，取值为0</td>
</tr>
</tbody>
</table>
<h2 id="exti外部中断">EXTI外部中断<a hidden class="anchor" aria-hidden="true" href="#exti外部中断">#</a></h2>
<ul>
<li>EXTI可以监测指定GPIO口的电平信号，当其指定的GPIO口产生电平变化时，EXTI将立即向NVIC发出中断申请，经过NVIC裁决后即可中断CPU主程序，使CPU执行EXTI对应的中断程序</li>
<li>支持的触发方式：上升沿/下降沿/双边沿/软件触发</li>
<li>支持的GPIO口：所有GPIO口，但相同的Pin不能同时触发中断</li>
<li>通道数：16个GPIO_Pin，外加PVD输出、RTC闹钟、USB唤醒、以太网唤醒</li>
<li>触发响应方式：中断响应/事件响应（中断响应是正常的流程，引脚电平变化触发中断；事件响应不会触发中断，而是触发别的外设操作，属于外设之间的联合工作）</li>
</ul>
<p><img loading="lazy" src="/../pictures/assets/image-20240725130858792.png" alt="image-20240725130858792"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240725131722207.png" alt="image-20240725131722207"  />
</p>
<h2 id="旋转编码器">旋转编码器<a hidden class="anchor" aria-hidden="true" href="#旋转编码器">#</a></h2>
<ul>
<li>旋转编码器：用来测量位置、速度或旋转方向的装置，当其旋转轴旋转时，其输出端可以输出与旋转速度和方向对应的方波信号，读取方波信号的频率和相位信息即可得知旋转轴的速度和方向</li>
<li>类型：机械触点式/霍尔传感器式/光栅式</li>
</ul>
<p><img loading="lazy" src="/../pictures/assets/image-20240725132855657.png" alt="image-20240725132855657"  />
</p>
<h2 id="基本流程">基本流程<a hidden class="anchor" aria-hidden="true" href="#基本流程">#</a></h2>
<ul>
<li>
<p>RCC时钟启用</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_GPIOB, ENABLE);<span style="color:#75715e">//启用GPIOB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_AFIO, ENABLE);<span style="color:#75715e">//启用AFIO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//EXTI与NVIC本身时钟就启用，无需启动
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>GPIO端口配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GPIO_InitTypeDef GPIO_InitStructure;<span style="color:#75715e">//定义结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>GPIO_InitStructure.GPIO_Mode <span style="color:#f92672">=</span> GPIO_Mode_IPU;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Pin <span style="color:#f92672">=</span> GPIO_Pin_14;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Speed <span style="color:#f92672">=</span> GPIO_Speed_50MHz;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">GPIO_Init</span>(GPIOB,<span style="color:#f92672">&amp;</span>GPIO_InitStructure);<span style="color:#75715e">//初始化
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>AFIO引脚选择</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">GPIO_EXTILineConfig</span>(GPIO_PortSourceGPIOB,GPIO_PinSource14);<span style="color:#75715e">//14脚使用GPIOB的Pin14
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>EXTI配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>EXTI_InitTypeDef EXTI_InitStructure;<span style="color:#75715e">//定义结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>EXTI_InitStructure.EXTI_Line <span style="color:#f92672">=</span> EXTI_Line14;<span style="color:#75715e">//启用14引脚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>EXTI_InitStructure.EXTI_LineCmd <span style="color:#f92672">=</span> ENABLE;<span style="color:#75715e">//使能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>EXTI_InitStructure.EXTI_Mode <span style="color:#f92672">=</span> EXTI_Mode_Interrupt;<span style="color:#75715e">//中断响应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>EXTI_InitStructure.EXTI_Trigger <span style="color:#f92672">=</span> EXTI_Trigger_Falling;<span style="color:#75715e">//下降沿触发
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">EXTI_Init</span>(<span style="color:#f92672">&amp;</span>EXTI_InitStructure);<span style="color:#75715e">//初始化
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>NVIC配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NVIC_InitTypeDef NVIC_InitStructure;<span style="color:#75715e">//定义结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">NVIC_PriorityGroupConfig</span>(NVIC_PriorityGroup_2);<span style="color:#75715e">//分组形式，2位抢占、2位响应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NVIC_InitStructure.NVIC_IRQChannel <span style="color:#f92672">=</span> EXTI15_10_IRQn;<span style="color:#75715e">//指定要启用的通道
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NVIC_InitStructure.NVIC_IRQChannelCmd <span style="color:#f92672">=</span> ENABLE;<span style="color:#75715e">//使能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#75715e">//抢占优先级 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NVIC_InitStructure.NVIC_IRQChannelSubPriority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#75715e">//响应优先级
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">NVIC_Init</span>(<span style="color:#f92672">&amp;</span>NVIC_InitStructure);<span style="color:#75715e">//初始化
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>NVIC配置后，可配置中断响应函数</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//对射式红外传感器计次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">EXTI15_10_IRQHandler</span>(<span style="color:#66d9ef">void</span>)<span style="color:#75715e">//名称与通道名对应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">EXTI_GetITStatus</span>(EXTI_Line14) <span style="color:#f92672">==</span> SET)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      CountSensor_Count<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Delay_ms</span>(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXTI_ClearITPendingBit</span>(EXTI_Line14);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//旋转编码器计次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int16_t</span> <span style="color:#a6e22e">Encoder_Get</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int16_t</span> Temp;
</span></span><span style="display:flex;"><span>  Temp <span style="color:#f92672">=</span> Encoder_Count;
</span></span><span style="display:flex;"><span>  Encoder_Count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Temp;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">EXTI0_IRQHandler</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">EXTI_GetITStatus</span>(EXTI_Line0) <span style="color:#f92672">==</span> SET)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">GPIO_ReadInputDataBit</span>(GPIOB,GPIO_Pin_1) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>          Encoder_Count <span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXTI_ClearITPendingBit</span>(EXTI_Line0);	
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">EXTI1_IRQHandler</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">EXTI_GetITStatus</span>(EXTI_Line1) <span style="color:#f92672">==</span> SET)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">GPIO_ReadInputDataBit</span>(GPIOB,GPIO_Pin_0) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>          Encoder_Count <span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">EXTI_ClearITPendingBit</span>(EXTI_Line1);	
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h1 id="tim定时器">TIM定时器<a hidden class="anchor" aria-hidden="true" href="#tim定时器">#</a></h1>
<h2 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h2>
<ul>
<li>定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断</li>
<li>16位计数器、预分频器、自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65s的定时</li>
<li>不仅具备基本的定时中断功能，而且还包含内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等多种功能</li>
<li>根据复杂度和应用场景分为了高级定时器、通用定时器、基本定时器三种类型</li>
</ul>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>编号</strong></th>
<th><strong>总线</strong></th>
<th><strong>功能</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>高级定时器</td>
<td>TIM1、TIM8</td>
<td>APB2</td>
<td>拥有通用定时器全部功能，并额外具有重复计数器、死区生成、互补输出、刹车输入等功能</td>
</tr>
<tr>
<td>通用定时器</td>
<td>TIM2、TIM3、TIM4、TIM5</td>
<td>APB1</td>
<td>拥有基本定时器全部功能，并额外具有内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等功能</td>
</tr>
<tr>
<td>基本定时器</td>
<td>TIM6、TIM7</td>
<td>APB1</td>
<td>拥有定时中断、主模式触发DAC的功能</td>
</tr>
</tbody>
</table>
<ul>
<li>STM32F103C8T6定时器资源：TIM1、TIM2、TIM3、TIM4</li>
<li>基本计时器只支持向上计数，通用定时器和高级定时器支持向上计数、向下计数、中央对齐三种模式</li>
</ul>
<p><img loading="lazy" src="/../pictures/assets/image-20240726100337802.png" alt="image-20240726100337802"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726100344350.png" alt="image-20240726100344350"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726100348286.png" alt="image-20240726100348286"  />
</p>
<p>定时中断基本结构如下</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726100901682.png" alt="image-20240726100901682"  />
</p>
<p>预分频器时序如下（PSC）</p>
<p>计数器计数频率：CK_CNT = CK_PSC / (PSC + 1)</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726130217934.png" alt="image-20240726130217934"  />
</p>
<p>计数器时序如下（ARR）</p>
<p>计数器溢出频率：CK_CNT_OV = CK_CNT / (ARR + 1)= CK_PSC / (PSC + 1) / (ARR + 1)</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726130720632.png" alt="image-20240726130720632"  />
</p>
<p>计数器无预装与有预装时序</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726131213925.png" alt="image-20240726131213925"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240726131217864.png" alt="image-20240726131217864"  />
</p>
<h2 id="定时中断">定时中断<a hidden class="anchor" aria-hidden="true" href="#定时中断">#</a></h2>
<ul>
<li>
<p>RCC使能</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">RCC_APB1PeriphClockCmd</span>(RCC_APB1Periph_TIM2,ENABLE);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>内部时钟模式</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_InternalClockConfig</span>(TIM2);<span style="color:#75715e">//内部时钟
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>时基单元</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;<span style="color:#75715e">//定义结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_ClockDivision <span style="color:#f92672">=</span> TIM_CKD_DIV1;<span style="color:#75715e">//时钟分频
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_CounterMode <span style="color:#f92672">=</span> TIM_CounterMode_Up;<span style="color:#75715e">//计数模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_Period <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;<span style="color:#75715e">//周期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_Prescaler <span style="color:#f92672">=</span> <span style="color:#ae81ff">7200</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;<span style="color:#75715e">//预分频器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_RepetitionCounter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;<span style="color:#75715e">//重计数值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">TIM_TimeBaseInit</span>(TIM2,<span style="color:#f92672">&amp;</span>TIM_TimeBaseInitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使能中断</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_ITConfig</span>(TIM2,TIM_IT_Update,ENABLE);<span style="color:#75715e">//更新时触发中断
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>NVIC</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NVIC_InitTypeDef NVIC_InitStructure;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NVIC_PriorityGroupConfig</span>(NVIC_PriorityGroup_2);
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannel <span style="color:#f92672">=</span> TIM2_IRQn;
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannelCmd <span style="color:#f92672">=</span> ENABLE;
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannelSubPriority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NVIC_Init</span>(<span style="color:#f92672">&amp;</span>NVIC_InitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动定时器</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_Cmd</span>(TIM2,ENABLE);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="外部时钟">外部时钟<a hidden class="anchor" aria-hidden="true" href="#外部时钟">#</a></h2>
<ul>
<li>
<p>RCC使能</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">RCC_APB1PeriphClockCmd</span>(RCC_APB1Periph_TIM2,ENABLE);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_GPIOA,ENABLE);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>GPIO配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GPIO_InitTypeDef GPIO_InitStructure;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Mode <span style="color:#f92672">=</span> GPIO_Mode_IPU;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Pin <span style="color:#f92672">=</span> GPIO_Pin_0;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Speed <span style="color:#f92672">=</span> GPIO_Speed_50MHz;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">GPIO_Init</span>(GPIOA,<span style="color:#f92672">&amp;</span>GPIO_InitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>外部时钟模式设置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_ETRClockMode2Config</span>(TIM2,TIM_ExtTRGPSC_OFF,TIM_ExtTRGPolarity_NonInverted,<span style="color:#ae81ff">0x0f</span>);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>时基单元配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_ClockDivision <span style="color:#f92672">=</span> TIM_CKD_DIV1;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_CounterMode <span style="color:#f92672">=</span> TIM_CounterMode_Up;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_Period <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_Prescaler <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_RepetitionCounter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">TIM_TimeBaseInit</span>(TIM2,<span style="color:#f92672">&amp;</span>TIM_TimeBaseInitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使能中断</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_ITConfig</span>(TIM2,TIM_IT_Update,ENABLE);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>NVIC配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NVIC_InitTypeDef NVIC_InitStructure;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NVIC_PriorityGroupConfig</span>(NVIC_PriorityGroup_2);
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannel <span style="color:#f92672">=</span> TIM2_IRQn;
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannelCmd <span style="color:#f92672">=</span> ENABLE;
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>NVIC_InitStructure.NVIC_IRQChannelSubPriority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NVIC_Init</span>(<span style="color:#f92672">&amp;</span>NVIC_InitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动定时器</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_Cmd</span>(TIM2,ENABLE);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="输出比较">输出比较<a hidden class="anchor" aria-hidden="true" href="#输出比较">#</a></h2>
<ul>
<li>OC(Output Compare)输出比较</li>
</ul>
<p>输出比较可以通过比较CNT与CCR寄存器值的关系，来对输出电平进行置1、置0或翻转的操作，用于输出一定频率和占空比的PWM波形</p>
<p>每个高级定时器和通用定时器都拥有4个输出比较通道</p>
<p>高级定时器的前3个通道额外拥有死区生成和互补输出的功能</p>
<ul>
<li>PWM脉冲宽度调制</li>
</ul>
<p>在具有惯性的系统中，可以通过对一系列脉冲的宽度进行调制，来等效地获得所需要的模拟参量，常应用于电机控速等领域</p>
<p>参数：频率 = 1 / TS            占空比 = TON / TS           分辨率 = 占空比变化步距</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240729143627862.png" alt="image-20240729143627862"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240729143631960.png" alt="image-20240729143631960"  />
</p>
<p>输出比较通道</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240729145715682.png" alt="image-20240729145715682"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240729145720153.png" alt="image-20240729145720153"  />
</p>
<p>输出比较模式</p>
<table>
<thead>
<tr>
<th><strong>模式</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>冻结</td>
<td>CNT=CCR时，REF保持为原状态</td>
</tr>
<tr>
<td>匹配时置有效电平</td>
<td>CNT=CCR时，REF置有效电平</td>
</tr>
<tr>
<td>匹配时置无效电平</td>
<td>CNT=CCR时，REF置无效电平</td>
</tr>
<tr>
<td>匹配时电平翻转</td>
<td>CNT=CCR时，REF电平翻转</td>
</tr>
<tr>
<td>强制为无效电平</td>
<td>CNT与CCR无效，REF强制为无效电平</td>
</tr>
<tr>
<td>强制为有效电平</td>
<td>CNT与CCR无效，REF强制为有效电平</td>
</tr>
<tr>
<td>PWM模式1</td>
<td>向上计数：CNT&lt;CCR时，REF置有效电平，CNT≥CCR时，REF置无效电平向下计数：CNT&gt;CCR时，REF置无效电平，CNT≤CCR时，REF置有效电平</td>
</tr>
<tr>
<td>PWM模式2</td>
<td>向上计数：CNT&lt;CCR时，REF置无效电平，CNT≥CCR时，REF置有效电平向下计数：CNT&gt;CCR时，REF置有效电平，CNT≤CCR时，REF置无效电平</td>
</tr>
</tbody>
</table>
<p>PWM基本结构</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240729161134432.png" alt="image-20240729161134432"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240729161222837.png" alt="image-20240729161222837"  />
</p>
<p>参数计算</p>
<ul>
<li>PWM频率：Freq = CK_PSC / (PSC + 1) / (ARR + 1)</li>
<li>PWM占空比：Duty = CCR / (ARR + 1)</li>
<li>PWM分辨率：Reso = 1 / (ARR + 1)</li>
</ul>
<h3 id="led呼吸灯">LED呼吸灯<a hidden class="anchor" aria-hidden="true" href="#led呼吸灯">#</a></h3>
<ul>
<li>
<p>内部时钟配置</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">TIM_InternalClockConfig</span>(TIM2);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>时基单元</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_ClockDivision <span style="color:#f92672">=</span> TIM_CKD_DIV1;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_CounterMode <span style="color:#f92672">=</span> TIM_CounterMode_Up;
</span></span><span style="display:flex;"><span>TIM_TimeBaseInitStructure.TIM_Period <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;<span style="color:#75715e">//ARR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_Prescaler <span style="color:#f92672">=</span> <span style="color:#ae81ff">720</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;<span style="color:#75715e">//PSC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_TimeBaseInitStructure.TIM_RepetitionCounter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">TIM_TimeBaseInit</span>(TIM2,<span style="color:#f92672">&amp;</span>TIM_TimeBaseInitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>输出比较单元</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>TIM_OCInitTypeDef TIM_OCinitStructure;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">TIM_OCStructInit</span>(<span style="color:#f92672">&amp;</span>TIM_OCinitStructure);<span style="color:#75715e">//给结构体赋初始值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_OCinitStructure.TIM_OCMode <span style="color:#f92672">=</span> TIM_OCMode_PWM1;<span style="color:#75715e">//输出比较模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_OCinitStructure.TIM_OCPolarity <span style="color:#f92672">=</span> TIM_OCPolarity_High;<span style="color:#75715e">//极性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_OCinitStructure.TIM_OutputState <span style="color:#f92672">=</span> TIM_OutputState_Enable;<span style="color:#75715e">//输出使能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TIM_OCinitStructure.TIM_Pulse <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;<span style="color:#75715e">//CCR的值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">TIM_OC1Init</span>(TIM2,<span style="color:#f92672">&amp;</span>TIM_OCinitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>GPIO</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>GPIO_InitTypeDef GPIO_InitStructure;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Mode <span style="color:#f92672">=</span> GPIO_Mode_AF_PP;<span style="color:#75715e">//复用推挽输出 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>GPIO_InitStructure.GPIO_Pin <span style="color:#f92672">=</span> GPIO_Pin_0;
</span></span><span style="display:flex;"><span>GPIO_InitStructure.GPIO_Speed <span style="color:#f92672">=</span> GPIO_Speed_50MHz ;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">GPIO_Init</span>(GPIOA,<span style="color:#f92672">&amp;</span>GPIO_InitStructure);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动定时器</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>TIM_Cmd(TIM2,ENABLE);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>控制PMW调亮度</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">PWM_SetCompare1</span>(<span style="color:#66d9ef">uint16_t</span> Compare)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TIM_SetCompare1</span>(TIM2,Compare);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="舵机">舵机<a hidden class="anchor" aria-hidden="true" href="#舵机">#</a></h3>
<p>舵机是一种根据输入PWM信号占空比来控制输出角度的装置</p>
<p>输入PWM信号要求：周期为20ms，高电平宽度为0.5ms~2.5ms</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240730090717165.png" alt="image-20240730090717165"  />
</p>
<ul>
<li><strong>PMW配置</strong>：内部时钟配置&mdash;&mdash;时基单元&mdash;&mdash;输出比较单元&mdash;&mdash;GPIO&mdash;&mdash;启动定时器</li>
<li><strong>舵机</strong>角度函数配置</li>
</ul>
<h3 id="直流电机">直流电机<a hidden class="anchor" aria-hidden="true" href="#直流电机">#</a></h3>
<p>直流电机是一种将电能转换为机械能的装置，有两个电极，当电极正接时，电机正转，当电极反接时，电机反转</p>
<p>直流电机属于大功率器件，GPIO口无法直接驱动，需要配合电机驱动电路来操作</p>
<p>TB6612是一款双路H桥型的直流电机驱动芯片，可以驱动两个直流电机并且控制其转速和方向</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240730091800308.png" alt="image-20240730091800308"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240730091804235.png" alt="image-20240730091804235"  />
</p>
<ul>
<li><strong>PMW配置</strong>：内部时钟配置&mdash;&mdash;时基单元&mdash;&mdash;输出比较单元&mdash;&mdash;GPIO&mdash;&mdash;启动定时器</li>
<li><strong>电机配置</strong>：复用推挽输出配置GPIO&mdash;&mdash;速度配置函数</li>
</ul>
<h2 id="输入捕获">输入捕获<a hidden class="anchor" aria-hidden="true" href="#输入捕获">#</a></h2>
<ul>
<li>IC（Input Capture）输入捕获</li>
<li>输入捕获模式下，当通道输入引脚出现指定电平跳变时，当前CNT的值将被锁存到CCR中，可用于测量PWM波形的频率、占空比、脉冲间隔、电平持续时间等参数</li>
<li>每个高级定时器和通用定时器都拥有4个输入捕获通道</li>
<li>可配置为PWMI模式，同时测量频率和占空比</li>
<li>可配合主从触发模式，实现硬件全自动测量</li>
</ul>
<p><img loading="lazy" src="/../pictures/assets/image-20240805103302644.png" alt="image-20240805103302644"  />
</p>
<h3 id="测频率">测频率<a hidden class="anchor" aria-hidden="true" href="#测频率">#</a></h3>
<p><img loading="lazy" src="/../pictures/assets/image-20240801111809291.png" alt="image-20240801111809291"  />
</p>
<ul>
<li>测频法：在闸门时间T内，对上升沿计次，得到N，则频率f_x=N / T</li>
<li>测周法：两个上升沿内，以标准频率fc计次，得到N ，则频率f_x=f_c / N</li>
<li>中界频率：测频法与测周法误差相等的频率点f_m=√f_c / T</li>
</ul>
<p>测频法要求信号频率高一些，测周法要求信号频率低一些。都存在±1误差</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240805111707938.png" alt="image-20240805111707938"  />
</p>
<p><img loading="lazy" src="/../pictures/assets/image-20240805111715049.png" alt="image-20240805111715049"  />
</p>
<h3 id="测占空比">测占空比<a hidden class="anchor" aria-hidden="true" href="#测占空比">#</a></h3>
<p><img loading="lazy" src="/../pictures/assets/image-20240805103527042.png" alt="image-20240805103527042"  />
</p>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="next" href="https://hangzz0910.github.io/posts/blog/blog/">
    <span class="title">下一页 »</span>
    <br>
    <span>我的hugo框架博客&#43;GitHub/阿里云服务器搭建历程</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: '👉展开评论';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: '👇关闭评论';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.6.22/twikoo.all.min.js">
    </script>
    <script>
        
        
        
        
        
        
        
        twikoo.init({
                envId: "https://twikoo-api-rho-virid.vercel.app/",  
                el: "#tcomment",
                lang: 'zh-CN',
                region: 'ap-shanghai',  
                path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
            });
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2023-2024
        <a href="https://hangzz0910.github.io/" style="color:#939393;">杭の小屋</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"杭の小屋"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"杭の小屋"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"杭の小屋"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
